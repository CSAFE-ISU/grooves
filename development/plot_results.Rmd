---
title: "Untitled"
output: html_document
---

```{r}
hamby44_paper <- readRDS("../data/hamby44/hamby44_paper.rda")

prediction_scores <- function(dataset, method){
  colname <- paste0("grooves_", method)
  new_colname <- paste0("score_left_", method)
  new_colname2 <- paste0("score_right_", method)
  dataset[,new_colname] <- 0
  dataset[,new_colname2] <- 0
  for(i in 1:nrow(dataset)){
    bullet <- dataset[i,]
    left_pred <- bullet[,colname][[1]][[1]]$groove[1]
    left_groove <- as.numeric(bullet[,"left_groove"])
    dat <- bullet$ccdata_w_resid[[1]]
    dat <- dat %>% filter(between(x, min(left_pred, left_groove), max(left_pred, left_groove)))
    dataset[i,new_colname] <- sum(dat$rlo_resid, na.rm = T)
    
    right_pred <- bullet[,colname][[1]][[1]]$groove[2]
    right_groove <- as.numeric(bullet[,"right_groove"])
    dat2 <- bullet$ccdata_w_resid[[1]]
    dat2 <- dat2 %>% filter(between(x, min(right_pred, right_groove), max(right_pred, right_groove)))
    dataset[i, new_colname2] <- sum(dat2$rlo_resid, na.rm = T)
  }
  return(dataset)
}



hamby44_plot <- prediction_scores(hamby44_paper, "rollapply")
hamby44_plot <- prediction_scores(hamby44_plot, "lassobasic")
hamby44_plot <- prediction_scores(hamby44_plot, "lassofull")
hamby44_plot <- prediction_scores(hamby44_plot, "bcp")


plot_scores <- function(dataset, methods = NULL){
  colnames <- c()
  for (i in 1:length(methods)){
    colnames <- c(colnames, paste0("score_left_", methods[i]))
    colnames <- c(colnames, paste0("score_right_", methods[i]))
  }
  plot_df <- dataset %>% ungroup() %>% 
    select(colnames) %>%  
    gather(method, score) %>% 
    mutate(GrooveMethod = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][3]
        })), GrooveSide = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][2]
        }))
    )
  plot_df %>% 
    ggplot() + geom_boxplot(aes(x = GrooveSide, y = abs(score), fill = GrooveMethod)) + 
      theme_bw() + labs(x = "Groove Side", y = "Inaccuracy Score")
}

plot_scores(hamby44_plot, methods = c("rollapply", "lassobasic", "lassofull", "bcp"))

head(hamby44_plot)


plot_scores_zoom <- function(dataset, zoom_cutoff, methods = NULL){
  colnames <- c()
  for (i in 1:length(methods)){
    colnames <- c(colnames, paste0("score_left_", methods[i]))
    colnames <- c(colnames, paste0("score_right_", methods[i]))
  }
  plot_df <- dataset %>% ungroup() %>% 
    select(colnames) %>%  
    gather(method, score) %>% 
    mutate(GrooveMethod = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][3]
        })), GrooveSide = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][2]
        }))
    ) %>% 
    filter(score < zoom_cutoff)
  plot_df %>% 
    ggplot() + geom_boxplot(aes(x = GrooveSide, y = abs(score), fill = GrooveMethod)) + 
      theme_bw() + labs(x = "Groove Side", y = "Inaccuracy Score")
}

plot_scores_zoom(hamby44_plot, zoom_cutoff = 5000, methods = c("rollapply", "lassobasic", "lassofull", "bcp"))








dataset <- hamby44_plot
  methods <- c("rollapply", "lassobasic", "lassofull", "bcp")
  colnames <- c()
  for (i in 1:length(methods)){
    colnames <- c(colnames, paste0("score_left_", methods[i]))
    colnames <- c(colnames, paste0("score_right_", methods[i]))
  }
  plot_df <- dataset %>% ungroup() %>% 
    select(colnames) %>%  
    gather(method, score) %>% 
    mutate(GrooveMethod = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][3]
        })), GrooveSide = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][2]
        }))
    ) %>% mutate(AccuracyCategory = ifelse(abs(score) < 100, "<100", "100, 1000")) %>% 
    mutate(AccuracyCategory = ifelse(abs(score) >= 1000, ">1000", AccuracyCategory))
  
  plot_df$GrooveLabels <- ifelse(plot_df$GrooveSide=="left", "left shoulder location", "right shoulder location")
  plot_df %>% 
    ggplot() + geom_bar(aes(x = GrooveMethod, fill=factor(AccuracyCategory, levels=c(">1000","100, 1000", "<100"))), position = "stack") + 
      theme_bw() + labs(x = "Groove Method", y = "Number of Lands") + 
    facet_wrap(~GrooveLabels ) + 
    scale_fill_manual(name="Inaccuracy Score", values=c("#E69F00", "#56B4E9", "#009E73"),
                         breaks=c(">1000", "100, 1000", "<100"),
                         labels=c("Greater than 1000", "Between 100 and 1000", "Less than 100")) + 
    scale_x_discrete(name = "Method", breaks = c("rollapply", "lassobasic", "lassofull", "bcp"), 
                     labels = c("Rollapply", "LASSO", "LASSO Interactions", "Bayesian Changepoint"), 
                     limits=c("rollapply","lassobasic","lassofull", "bcp")) + 
    theme(axis.text.x = element_text(angle =10, size = 8))
  



```


```{r}
plot_preds <- function(dataset, bullet_num){
  bullet <- dataset$ccdata[[bullet_num]]
  rollapply_left <- dataset$grooves_rollapply[[bullet_num]]$groove[1]
  rollapply_right <- dataset$grooves_rollapply[[bullet_num]]$groove[2]
  
  lassofull_left <- dataset$grooves_lassofull[[bullet_num]]$groove[1]
  lassofull_right <- dataset$grooves_lassofull[[bullet_num]]$groove[2]
  
  bcp_left <- dataset$grooves_bcp[[bullet_num]]$groove[1]
  bcp_right <- dataset$grooves_bcp[[bullet_num]]$groove[2]
  
  left <- dataset$left_groove[[bullet_num]]
  right <- dataset$right_groove[[bullet_num]]
  
  bullet %>% ggplot() + theme_bw() + 
    geom_point(aes(x = x, y = value), size = 0.5) + 
    
    geom_vline(aes(xintercept = left), lty = 1, colour = "gray31", lwd = 1.3) + 
    geom_vline(aes(xintercept = right), lty = 1, colour = "gray31", lwd = 1.3) + 
    
    geom_vline(aes(xintercept = rollapply_left), lty = 2, lwd = 1.1, colour = "#E69F00") + 
    geom_vline(aes(xintercept = rollapply_right), lty = 2, lwd = 1.1, colour = "#E69F00") + 
    
    geom_vline(aes(xintercept = lassofull_left), lty = 3, lwd = 1.1, colour = "#009E73") + 
    geom_vline(aes(xintercept = lassofull_right), lty = 3, lwd = 1.1, colour = "#009E73") + 
    
    geom_vline(aes(xintercept = bcp_left), lty = 4, lwd = 1.1, colour = "#56B4E9") + 
    geom_vline(aes(xintercept = bcp_right), lty = 4, lwd = 1.1, colour = "#56B4E9")
    
}
```